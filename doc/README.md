# Algorithm description

The algorithm uses three static/fixed variables (`urban fraction`, `orography`, and `land-sea mask`) along with several hyperparameters (see Table 1) to determine which cells are considered urban and which rural surroundings. First, the location of the city of interest (`lon_city` and `lat_city`) and the study area (`lon_lim` and `lat_lim`) must be defined in geographic coordinates. Only those cells inside the limits of the study area can be selected as urban or rural. Then, the Urban Fraction (UF) threshold (`urban_th`) determines the grid cells that represent urban areas in the model. Cells with UF values higher than the urban threshold are considered urban cells. Small satellite urban areas not connected to the city’s core can be excluded using the `min_city_size` parameter. This parameter filters out small urban clusters, classifying them as neither urban nor rural, while preserving the main urban cluster closest to the `lon_city` and `lat_city` coordinates, regardless of its number of cells. The parameter `urban_sur_th` creates a buffer zone around urban cells. Cells with UF values between `urban_th` and `urban_sur_th`, which might be affected by the urban climate and should not be considered rural surrounding areas, are excluded from the analysis. This parameter is particularly relevant for high-resolution climate models and only affects the results if the hyperparameters `urban_th` and `urban_sur_th` are different.

The algorithm identifies urban areas based on the `urban_th` parameter and uses the static variables `orography` and `land-sea mask` to create three masks which serve to define which cells might be considered rural. The parameter `orog_diff` excludes mountainous areas around the city by masking surrounding grid cells with an altitude difference between the maximum and minimum elevation of the urban cells. Large water bodies, such as lakes, oceans and rivers, are excluded with the parameter `sftlf_th` (note that this parameter also affects the urban areas). Grid cells complying with these criteria are selected as candidate surrounding areas through an iterative process using a morphological dilation function relative to the urban cells. The ratio of the number of urban vs rural cells is defined by the parameter `scale`.

The morphological dilation function is available in the scikit-image Python package (https://scikit-image.org/). This function sets the value of a pixel to the maximum over all pixel values within a local neighborhood centered around it. The values where the footprint is 1 define this neighborhood. Two shapes of footprints or kernels are implemented. For each iteration, a morphological dilation with a cross-shaped footprint is first applied, allowing 4-connected cells to be neighbors of any cell that touches one of their edges. If the cross-shaped footprint iteration does not select any rural cells, a square footprint is then applied, including 4 additional connected samples (edges and diagonals). These two types of different footprints are implemented because, in some cities, the cross-shaped footprint does not return any rural surrounding cell for coarse resolution models (see Figure X). In each iteration, masked values including water bodies, elevation differences, and urban cells are excluded. The iterative process is finalized when the number of rural surrounding cells reaches the proportion defined by the `scale` parameter.

Figure 1 illustrates an example of the results obtained by applying the algorithm for the city of Buenos Aires, Argentina, using the REMO model. The first row of panels display the three static variables used by the algorithm: UF, orography, and land-sea mask, respectively. The second row of panels show the same variables, but masked based on the following hyperparameters “urban_th” = 10%,  “orog_diff” = 50 m and “sftfl_th” = 70%. Cells with red borders represent urban cells selected by the algorithm (“scale = 2”, “urban_sur_th = 0” and “max_city = 0”), while cells with blue borders represent the surrounding cells.

![Urban Climate Mask](BuenosAires.png)

Figure 1. Urban (red-border cells) and rural (blue-border cells) masks for the city of Buenos Aires using REMO. The top panels illustrate the three static variables used by the algorithm to delineate urban and rural areas: urban fraction (UF), orography, and land-sea mask. The bottom panels show the same static variables, but masked according to the selected hyperparameters, along with the resulting urban and rural cells.



| **Hyperparameter**   | **Description** |
|----------------------|-----------------|
| `lon_city` and `lat_city` | Longitude and latitude of the city center. |
| `lon_lim` and `lat_lim` | Limits of the study area relative to the city center (`lon_city` and `lat_city`). Cells outside these limits are excluded from the analysis. |
| `urban_th` | Urban fraction threshold (%). Cells with urban fraction values above this threshold are classified as urban cells. |
| `urban_sur_th` | Urban surrounding threshold (%). Cells with urban fraction values below this threshold are candidates to be rural surrounding cells. |
| `orog_diff` | Altitude difference (m) relative to the maximum and minimum elevation of the urban cells. Pixels with a higher altitude difference are excluded from the analysis. |
| `sftlf_th` | Minimum land percentage required to include a cell in the analysis. |
| `min_city_size` | Minimum size for urban clusters. Urban clusters with a number of connected cells equal to or lower than this threshold are excluded from the analysis, except for the main city cluster closest to the `lon_city` and `lat_city` coordinates, which is retained regardless of its size. |
| `scale` | Ratio of rural to urban grid cells. Dilation functions stop once this ratio is reached. |

**Table 1.** Description of the hyperparameters currently implemented in the algorithm.
